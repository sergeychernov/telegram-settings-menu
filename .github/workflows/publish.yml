name: Publish Packages to NPM

on:
  push:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞–µ–º CI/CD —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          registry-url: "https://registry.npmjs.org/"

      - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.6.0 --activate

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: yarn install --immutable

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        id: check_changes
        run: |
          if git diff --name-only HEAD~1 | grep -q "packages/telegram-settings-menu/"; then
            echo "MENU_CHANGED=true" >> $GITHUB_ENV
          else
            echo "MENU_CHANGED=false" >> $GITHUB_ENV
          fi
          if git diff --name-only HEAD~1 | grep -q "packages/telegram-settings-menu-generator/"; then
            echo "GENERATOR_CHANGED=true" >> $GITHUB_ENV
          else
            echo "GENERATOR_CHANGED=false" >> $GITHUB_ENV
          fi
          if git diff --name-only HEAD~1 | grep -q "packages/tele-menu-demo-bot/"; then
            echo "BOT_CHANGED=true" >> $GITHUB_ENV
          else
            echo "BOT_CHANGED=false" >> $GITHUB_ENV
          fi

      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Yandex Cloud CLI
        if: env.BOT_CHANGED == 'true'
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
          source ~/.bashrc

      - name: üîß Setup Yandex Cloud CLI
        if: env.BOT_CHANGED == 'true'
        run: |
          yc --version
          echo "${{ secrets.SA_KEY_FILE }}" | base64 --decode > packages/tele-menu-demo-bot/ydb-key.json
          echo "${{ secrets.DEP_KEY}}" | base64 --decode > packages/tele-menu-demo-bot/dep-key.json
          yc config set service-account-key packages/tele-menu-demo-bot/dep-key.json
          yc config set cloud-id "${{ secrets.CLOUD_ID }}"
          yc config set folder-id "${{ secrets.FOLDER_ID }}"
          yc config profile list

      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ telegram-settings-menu
        if: env.MENU_CHANGED == 'true' || env.BOT_CHANGED == 'true'
        run: yarn workspace telegram-settings-menu run build

      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ telegram-settings-menu-generator
        if: env.GENERATOR_CHANGED == 'true'
        run: yarn workspace telegram-settings-menu-generator run build

      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ tele-menu-demo-bot
        if: env.BOT_CHANGED == 'true'
        run: |
          yarn workspace tele-menu-demo-bot run build
          
      
      - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è `tele-menu-demo-bot`
        if: env.BOT_CHANGED == 'true'
        run: |
          yc serverless function list --folder-id "${{ secrets.FOLDER_ID }}" --cloud-id "${{ secrets.CLOUD_ID }}"
          echo "${{ secrets.BOT_ENV }}" | base64 --decode > packages/tele-menu-demo-bot/.env
          echo "${{ secrets.ENV }}" | base64 --decode > .env
          yarn workspace tele-menu-demo-bot version patch
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"
          git add packages/tele-menu-demo-bot/package.json
          git commit -m "ci: bump tele-menu-demo-bot version [skip ci]"
          git push
          ./scripts/publish-func-ver.sh tele-menu-demo-bot
          rm -f packages/tele-menu-demo-bot/ydb-key.json
        env:
          SERVICE_ACCOUNT_ID: ${{ secrets.SERVICE_ACCOUNT_ID }}
          CLOUD_ID: ${{ secrets.CLOUD_ID }}
          FOLDER_ID: ${{ secrets.FOLDER_ID }}

      - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è `telegram-settings-menu`
        if: env.MENU_CHANGED == 'true'
        run: |
          PUBLISHED_VERSION=$(npm view telegram-settings-menu version || echo "0.0.0")
          CURRENT_VERSION=$(jq -r .version packages/telegram-settings-menu/package.json)

          echo "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: $PUBLISHED_VERSION"
          echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –≤ package.json: $CURRENT_VERSION"

          if [ "$CURRENT_VERSION" = "$PUBLISHED_VERSION" ]; then
            echo "–í–µ—Ä—Å–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –ø–æ–≤—ã—à–∞–µ–º –≤–µ—Ä—Å–∏—é..."
            yarn workspace telegram-settings-menu version patch
            git config --local user.email "github-actions@github.com"
            git config --local user.name "GitHub Actions"
            git add packages/telegram-settings-menu/package.json
            git commit -m "ci: bump telegram-settings-menu version [skip ci]"
            git push
          else
            echo "–í–µ—Ä—Å–∏—è —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≤—ã—à–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏."
          fi
          
          NEW_VERSION=$(jq -r .version packages/telegram-settings-menu/package.json)

          echo "–ü—É–±–ª–∏–∫—É–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é: $NEW_VERSION"

          yarn workspace telegram-settings-menu npm publish --access public

        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è `telegram-settings-menu-generator`
        if: env.GENERATOR_CHANGED == 'true'
        run: |
          PUBLISHED_VERSION=$(npm view telegram-settings-menu-generator version || echo "0.0.0")
          CURRENT_VERSION=$(jq -r .version packages/telegram-settings-menu-generator/package.json)

          echo "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: $PUBLISHED_VERSION"
          echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –≤ package.json: $CURRENT_VERSION"

          if [ "$CURRENT_VERSION" = "$PUBLISHED_VERSION" ]; then
            echo "–í–µ—Ä—Å–∏–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç, –ø–æ–≤—ã—à–∞–µ–º –≤–µ—Ä—Å–∏—é..."
            yarn workspace telegram-settings-menu-generator version patch
            git config --local user.email "github-actions@github.com"
            git config --local user.name "GitHub Actions"
            git add packages/telegram-settings-menu-generator/package.json
            git commit -m "ci: bump telegram-settings-menu-generator version [skip ci]"
            git push
          else
            echo "–í–µ—Ä—Å–∏—è —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≤—ã—à–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏."
          fi
          
          NEW_VERSION=$(jq -r .version packages/telegram-settings-menu-generator/package.json)

          echo "–ü—É–±–ª–∏–∫—É–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é: $NEW_VERSION"

          yarn workspace telegram-settings-menu-generator npm publish --access public

        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
